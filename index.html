<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Monk Mode</title>
<style>
  :root{
    --bg:#0f1116;
    --panel:#151b22;
    --panel-2:#1a202b;
    --text:#eef1f7;
    --muted:#9aa0ad;
    --border:#242b39;
    --danger:#ff5b6a;
    --shadow: 0 10px 28px rgba(0,0,0,.35);
    --r:14px;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Apple Color Emoji","Segoe UI Emoji";
    background:
      radial-gradient(1200px 600px at 50% -220px, #20283a 0%, rgba(32,40,58,0.65) 35%, rgba(15,17,22,0) 60%),
      var(--bg);
    color:var(--text);
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:5;
    padding:12px 14px 6px;
    background:linear-gradient(180deg, rgba(10,12,18,.9), rgba(10,12,18,.55) 65%, rgba(10,12,18,0));
    backdrop-filter: blur(6px);
    border-bottom:1px solid rgba(255,255,255,.04);
  }
  .week{
    display:flex; gap:8px; align-items:center; justify-content:space-between;
  }
  .day{
    flex:1; padding:8px 0; text-align:center;
    border:1px solid var(--border);
    background:var(--panel);
    color:var(--muted);
    border-radius:10px;
    cursor:pointer; user-select:none;
    transition: transform .06s ease;
  }
  .day:active{ transform: translateY(1px); }
  .day .dow{ display:block; font-size:12px; font-weight:700; letter-spacing:.2px; }
  .day .date{ display:block; font-size:11px; opacity:.9; margin-top:2px; }
  .day.today{ outline:2px solid #6b8cff; color:var(--text); }
  .day.active{ background:#1e2532; color:var(--text); }

  /* Main container */
  .container{ max-width:840px; margin: 10px auto 110px; padding:0 14px; }
  .tiles{ display:flex; flex-direction:column; gap:12px; }

  /* Tile */
  .tile{
    position:relative; overflow:hidden;
    border:1px solid var(--border);
    background:var(--panel);
    border-radius: var(--r);
    box-shadow: var(--shadow);
    padding:16px;
    min-height:62px;
    cursor:pointer;
  }
  .tile .row{
    position:relative; z-index:2;
    display:flex; align-items:baseline; justify-content:space-between;
  }
  .tile .name{ font-weight:800; font-size:16px; letter-spacing:.2px; }
  .tile .value{ font-weight:700; font-size:14px; color:#dfe3ed; }

  /* progress background/fill */
  .bar{
    position:absolute; inset:0; z-index:1;
  }
  .bar-bg{ opacity:.22; }
  .bar-fill{
    width:0%; transition: width .35s ease;
    mix-blend-mode: screen;
  }

  /* Add tile (faded) */
  .tile.add{
    display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg, #141a26, #111722);
    color:var(--muted);
    border-style:dashed;
  }
  .tile.add .plus{ display:flex; gap:10px; align-items:center; font-weight:800; opacity:.85; }
  .tile.add svg{ width:20px; height:20px; }

  /* Overlays */
  .overlay{
    position:fixed; inset:0; display:none; place-items:center; z-index:20;
    background: rgba(5,7,10,.55); backdrop-filter: blur(3px);
    padding: 10px;
  }
  .panel{
    width:min(760px, 96vw);
    background: var(--panel-2);
    border:1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .panel header{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px;
    background:#192030;
    border-bottom:1px solid var(--border);
  }
  .panel h3{ margin:0; font-size:16px; letter-spacing:.2px; }

  .iconbtn{
    width:42px; height:42px; border-radius:12px;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid var(--border); background:#121722; color:var(--text);
    cursor:pointer;
  }
  .iconbtn.danger{ background:#28181b; border-color:#3a2326; color:#ffdfe1; }
  .iconbtn svg{ width:22px; height:22px; }

  .content{ padding: 20px; display:flex; flex-direction:column; align-items:center; gap:18px; }

  /* Circular progress */
  .ring{ width:min(320px, 75vw); aspect-ratio:1/1; position:relative; }
  .ring svg{ width:100%; height:100%; transform: rotate(-90deg); }
  .ring .center{
    position:absolute; inset:0; display:flex; flex-direction:column; place-content:center; place-items:center; text-align:center;
  }
  .ring .current{ font-weight:900; font-size:28px; letter-spacing:.4px; }
  .ring .goal{ margin-top:4px; font-size:13px; color:var(--muted); }

  /* Action buttons */
  .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; }
  .btn{
    border:none; cursor:pointer; padding:12px 18px; border-radius:12px;
    font-weight:800; letter-spacing:.3px; color:var(--text);
    background:#232a3b; border:1px solid var(--border);
    min-width:120px;
  }
  .btn.secondary{ background:#1b2130; }
  .btn.danger{ background:#2a181b; border-color:#3a2326; color:#ffdfe1; }
  .btn.small{
    padding:10px; min-width:auto; width:46px; height:46px; border-radius:999px;
    display:inline-flex; align-items:center; justify-content:center;
  }
  .btn svg{ width:20px; height:20px; }

  /* Confirm modal */
  .confirm-wrap{ position:fixed; inset:0; display:none; place-items:center; z-index:50; background: rgba(6,8,12,.6); backdrop-filter: blur(2px); padding:10px; }
  .confirm{
    width:min(420px, 96vw);
    background:#161b28; border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow: var(--shadow);
  }
  .confirm h4{ margin:4px 0 8px; }
  .confirm p{ margin:0 0 14px; color:#cfd3df; }
  .confirm .rowbtn{ display:flex; gap:10px; justify-content:flex-end; }
  .confirm .rowbtn .btn{ min-width:110px; }

  /* Setup form */
  .formgrid{ display:grid; gap:12px; width:100%; }
  .field{ display:flex; flex-direction:column; gap:6px; background:#141a26; border:1px solid var(--border); border-radius:12px; padding:10px 12px; }
  .field label{ font-size:12px; color:var(--muted); }
  .field input[type="text"], .field input[type="number"], .field input[type="date"], .field input[type="color"]{
    background:transparent; border:none; outline:none; color:var(--text); font-size:16px;
  }
  .row-split{ display:flex; gap:12px; }
  .row-split .field{ flex:1; }

  .hidden{ display:none !important; }
</style>
</head>
<body>

  <!-- Top Week Selector -->
  <div class="topbar">
    <div id="week" class="week"></div>
  </div>

  <!-- Tiles -->
  <div class="container">
    <div id="tiles" class="tiles"></div>
  </div>

  <!-- Detail Overlay -->
  <div id="detailOverlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <header>
        <button id="detailBack" class="iconbtn" title="Back" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <h3 id="detailTitle">Tile</h3>
        <button id="detailDelete" class="iconbtn danger" title="Delete tile" aria-label="Delete tile">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </header>
      <div class="content">
        <div class="ring" id="ring">
          <svg id="ringSvg" viewBox="0 0 280 280" aria-hidden="true"></svg>
          <div class="center">
            <div class="current" id="ringCurrent">0</div>
            <div class="goal" id="ringGoal">Goal: 0</div>
          </div>
        </div>
        <div class="actions">
          <button id="btnAdd" class="btn">Add</button>
          <button id="btnReset" class="btn small" title="Reset to zero" aria-label="Reset to zero">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 3-6.708M3 5v5h5"/>
            </svg>
          </button>
          <button id="btnGoal" class="btn secondary">Goal</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmWrap" class="confirm-wrap" aria-hidden="true">
    <div class="confirm" role="dialog" aria-modal="true">
      <h4 id="confirmTitle">Confirm</h4>
      <p id="confirmMessage">Are you sure?</p>
      <div class="rowbtn">
        <button id="confirmNo" class="btn secondary">No</button>
        <button id="confirmYes" class="btn danger">Yes</button>
      </div>
    </div>
  </div>

  <!-- Setup (Add Tile) Overlay -->
  <div id="setupOverlay" class="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <header>
        <button id="setupBack" class="iconbtn" title="Back" aria-label="Back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <h3>Add Tile</h3>
        <span style="width:42px;height:42px"></span>
      </header>
      <div class="content">
        <div class="formgrid">
          <div class="field">
            <label for="fName">Name</label>
            <input id="fName" type="text" placeholder="Calories, Protein, Sleep…">
          </div>
          <div class="field">
            <label for="fGoal">Goal</label>
            <input id="fGoal" type="number" inputmode="decimal" placeholder="e.g. 2500">
          </div>
          <div class="row-split">
            <div class="field">
              <label for="fStart">Start Date</label>
              <input id="fStart" type="date">
            </div>
            <div class="field">
              <label for="fEnd">End Date (optional)</label>
              <input id="fEnd" type="date">
            </div>
          </div>
          <div class="field">
            <label for="fColor">Colour</label>
            <input id="fColor" type="color" value="#6b8cff">
          </div>
        </div>
        <div class="actions">
          <button id="setupSave" class="btn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= Helpers & Storage ================= */
const $ = s => document.querySelector(s);
const nf = new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 });
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const iso = d => d.toISOString().slice(0,10);

function startOfWeek(date){
  const d = new Date(date);
  const day = (d.getDay()+6)%7; // Monday=0
  d.setDate(d.getDate()-day);
  d.setHours(0,0,0,0);
  return d;
}
function addDays(date, n){ const d = new Date(date); d.setDate(d.getDate()+n); return d; }
function escapeHTML(str){ return (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

const LS_KEY = 'monkmode.v2';
function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return { tiles:[], values:{} };
    const parsed = JSON.parse(raw);
    return { tiles: parsed.tiles||[], values: parsed.values||{} };
  }catch(e){ return { tiles:[], values:{} }; }
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

let state = load();
let activeDate = iso(new Date());
let activeTileId = null;

/* ================= Week Render ================= */
function renderWeek(){
  const wrap = $('#week'); wrap.innerHTML='';
  const monday = startOfWeek(new Date(activeDate));
  const todayISO = iso(new Date());
  const dows = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  for(let i=0;i<7;i++){
    const d = addDays(monday, i);
    const id = iso(d);
    const el = document.createElement('div');
    el.className = 'day' + (id===todayISO?' today':'') + (id===activeDate?' active':'');
    el.innerHTML = `<span class="dow">${dows[i]}</span><span class="date">${d.getDate()}/${d.getMonth()+1}</span>`;
    el.addEventListener('click', ()=>{ activeDate=id; renderAll(); });
    wrap.appendChild(el);
  }
}

/* ================= Tiles Render ================= */
function inRange(tile, dateISO){
  if(tile.startDate && dateISO < tile.startDate) return false;
  if(tile.endDate && dateISO > tile.endDate) return false;
  return true;
}
function getValue(tileId, dateISO){
  return (state.values[dateISO] && state.values[dateISO][tileId]) || 0;
}
function setValue(tileId, dateISO, val){
  state.values[dateISO] = state.values[dateISO] || {};
  state.values[dateISO][tileId] = val;
  save();
}
function deleteTileEverywhere(tileId){
  state.tiles = state.tiles.filter(t=>t.id!==tileId);
  for(const d in state.values){
    if(state.values[d] && tileId in state.values[d]) delete state.values[d][tileId];
  }
  save();
}

function renderTiles(){
  const list = $('#tiles'); list.innerHTML='';
  const tiles = state.tiles.filter(t=>inRange(t, activeDate));

  tiles.forEach(tile=>{
    const v = getValue(tile.id, activeDate);
    const pct = tile.goal>0 ? clamp(v/tile.goal, 0, 1) : 0;

    const el = document.createElement('div');
    el.className = 'tile';
    el.innerHTML = `
      <div class="bar bar-bg" style="background:${tile.color}"></div>
      <div class="bar bar-fill" style="background:${tile.color}; width:${pct*100}%"></div>
      <div class="row">
        <div class="name">${escapeHTML(tile.name)}</div>
        <div class="value">${nf.format(v)}</div>
      </div>
    `;
    el.addEventListener('click', ()=>openDetail(tile.id));
    list.appendChild(el);
  });

  // Faded "Add Tile"
  const addTile = document.createElement('div');
  addTile.className = 'tile add';
  addTile.innerHTML = `
    <div class="plus">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      <span>Add Tile</span>
    </div>`;
  addTile.addEventListener('click', openSetup);
  list.appendChild(addTile);
}

/* ================= Detail View ================= */
const ringSvg = $('#ringSvg');
let ringFG=null, ringBG=null, ringCircum=0;

function buildRing(color){
  ringSvg.innerHTML='';
  const size=280, stroke=14, r=(size/2)-stroke, c=2*Math.PI*r;

  const mk = (name, attrs) => {
    const el = document.createElementNS('http://www.w3.org/2000/svg', name);
    for(const k in attrs) el.setAttribute(k, attrs[k]);
    return el;
  };

  const bg = mk('circle', {cx:size/2, cy:size/2, r:r, fill:'none', stroke:color, 'stroke-opacity':'0.22', 'stroke-width':stroke});
  const fg = mk('circle', {cx:size/2, cy:size/2, r:r, fill:'none', stroke:color, 'stroke-width':stroke, 'stroke-linecap':'round'});
  fg.setAttribute('stroke-dasharray', `${c} ${c}`);
  fg.setAttribute('stroke-dashoffset', `${c}`);

  ringSvg.appendChild(bg);
  ringSvg.appendChild(fg);
  ringFG = fg; ringBG = bg; ringCircum = c;
}

function animateRingTo(pct){
  pct = clamp(pct,0,1);
  const target = ringCircum * (1 - pct);
  ringFG.style.transition = 'stroke-dashoffset .45s ease';
  // stroke-dashoffset is measured from full circle (c) but we rotated -90deg, so we draw pct
  ringFG.style.strokeDashoffset = String(ringCircum - (ringCircum * pct));
}

function openDetail(tileId){
  activeTileId = tileId;
  const tile = state.tiles.find(t=>t.id===tileId);
  if(!tile) return;
  $('#detailTitle').textContent = tile.name;

  buildRing(tile.color);
  const v = getValue(tile.id, activeDate);
  $('#ringCurrent').textContent = nf.format(v);
  $('#ringGoal').textContent = `Goal: ${nf.format(tile.goal||0)}`;
  animateRingTo(tile.goal>0 ? v/tile.goal : 0);

  $('#detailOverlay').style.display='grid';
  $('#detailOverlay').setAttribute('aria-hidden','false');
}

function closeDetail(){
  $('#detailOverlay').style.display='none';
  $('#detailOverlay').setAttribute('aria-hidden','true');
  activeTileId = null;
  renderTiles();
}

/* ================= Confirm Dialog ================= */
let confirmResolve = null;
function confirmDialog(title, message){
  $('#confirmTitle').textContent = title;
  $('#confirmMessage').textContent = message;
  $('#confirmWrap').style.display='grid';
  $('#confirmWrap').setAttribute('aria-hidden','false');
  return new Promise(res=>{ confirmResolve = res; });
}
$('#confirmNo').addEventListener('click', ()=>{
  $('#confirmWrap').style.display='none';
  $('#confirmWrap').setAttribute('aria-hidden','true');
  confirmResolve && confirmResolve(false);
});
$('#confirmYes').addEventListener('click', ()=>{
  $('#confirmWrap').style.display='none';
  $('#confirmWrap').setAttribute('aria-hidden','true');
  confirmResolve && confirmResolve(true);
});

/* ================= Setup (Add Tile) ================= */
function openSetup(){
  $('#fName').value='';
  $('#fGoal').value='';
  $('#fStart').value = activeDate;
  $('#fEnd').value = '';
  $('#fColor').value = '#6b8cff';
  $('#setupOverlay').style.display='grid';
  $('#setupOverlay').setAttribute('aria-hidden','false');
}
function closeSetup(){
  $('#setupOverlay').style.display='none';
  $('#setupOverlay').setAttribute('aria-hidden','true');
}
$('#setupSave').addEventListener('click', ()=>{
  const name = ($('#fName').value||'').trim();
  let goal = parseFloat($('#fGoal').value||'0'); if(!isFinite(goal)||goal<0) goal=0;
  const startDate = $('#fStart').value || null;
  const endDate = ($('#fEnd').value||'').trim() || null;
  const color = $('#fColor').value || '#6b8cff';
  if(!name){ alert('Please enter a name.'); return; }

  state.tiles.push({
    id: 't'+Date.now().toString(36)+Math.random().toString(36).slice(2,7),
    name, goal, startDate, endDate, color
  });
  save();
  closeSetup();
  renderAll();
});
$('#setupBack').addEventListener('click', closeSetup);

/* ================= Detail Buttons ================= */
$('#detailBack').addEventListener('click', closeDetail);

$('#detailDelete').addEventListener('click', async ()=>{
  if(activeTileId==null) return;
  const tile = state.tiles.find(t=>t.id===activeTileId);
  const ok = await confirmDialog('Delete tile', `Delete “${tile?.name}”? This removes it from all days.`);
  if(ok){ deleteTileEverywhere(activeTileId); closeDetail(); }
});

$('#btnAdd').addEventListener('click', ()=>{
  if(activeTileId==null) return;
  const tile = state.tiles.find(t=>t.id===activeTileId);
  const input = prompt(`Add to "${tile.name}"\nEnter amount to add:`, '0');
  if(input===null) return;
  let add = parseFloat(String(input).replace(/,/g,''));
  if(!isFinite(add)) add = 0;
  const current = getValue(tile.id, activeDate);
  const next = current + add;
  setValue(tile.id, activeDate, next);

  // update UI
  $('#ringCurrent').textContent = nf.format(next);
  $('#ringGoal').textContent = `Goal: ${nf.format(tile.goal||0)}`;
  animateRingTo(tile.goal>0 ? next/tile.goal : 0);
});

$('#btnGoal').addEventListener('click', ()=>{
  if(activeTileId==null) return;
  const tile = state.tiles.find(t=>t.id===activeTileId);
  const input = prompt(`Set goal for "${tile.name}":`, String(tile.goal||0));
  if(input===null) return;
  let g = parseFloat(String(input).replace(/,/g,''));
  if(!isFinite(g)||g<0) g=0;
  tile.goal = g; save();

  const v = getValue(tile.id, activeDate);
  $('#ringGoal').textContent = `Goal: ${nf.format(tile.goal||0)}`;
  animateRingTo(tile.goal>0 ? v/tile.goal : 0);
});

$('#btnReset').addEventListener('click', async ()=>{
  if(activeTileId==null) return;
  const tile = state.tiles.find(t=>t.id===activeTileId);
  const ok = await confirmDialog('Reset to zero', `Reset "${tile.name}" for this day to 0?`);
  if(!ok) return;
  setValue(tile.id, activeDate, 0);
  $('#ringCurrent').textContent = '0';
  animateRingTo(0);
});

/* ================= Swipe Navigation (mobile) ================= */
let touchStartX=null;
document.addEventListener('touchstart', e=>{
  if(e.touches.length===1) touchStartX = e.touches[0].clientX;
},{passive:true});
document.addEventListener('touchend', e=>{
  if(touchStartX==null) return;
  const dx = e.changedTouches[0].clientX - touchStartX; touchStartX=null;
  if(Math.abs(dx)<50) return;
  const d = new Date(activeDate);
  d.setDate(d.getDate() + (dx<0 ? 1 : -1)); // left swipe -> next day
  activeDate = iso(d);
  renderAll();
},{passive:true});

/* ================= Bootstrap ================= */
function renderAll(){ renderWeek(); renderTiles(); }
renderAll();
</script>
</body>
</html>
